name: Build and Release MCPB Bundle

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Type check
        run: npm run typecheck

      - name: Build TypeScript
        run: npm run build

      - name: Package MCPB bundle
        run: node build-bundle.cjs

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create Release with MCPB Bundle
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Find the generated .mcpb file
          MCPB_FILE=$(ls *.mcpb | head -n 1)

          gh release create ${{ github.ref_name }} \
            --title "Memory MCP ${{ steps.get_version.outputs.VERSION }}" \
            --notes "## Memory MCP v2.0 - Dual-Response Progressive Loading

          ### Features
          - üß† Brain-inspired memory system
          - ‚ö° 50% token savings with dual-response architecture
          - üîç SQLite FTS5 search (lightweight ~6MB bundle)
          - üìä Automatic importance scoring and TTL management
          - üîó Full provenance tracking
          - üéØ Token-aware with \`max_tokens\` parameter
          - ‚ú® 3 streamlined tools (memory_store, memory_recall, memory_forget)

          ### Installation
          1. Download \`memory-mcp-*.mcpb\` bundle below
          2. Claude Desktop ‚Üí Settings ‚Üí Developer ‚Üí Install unpacked extension
          3. Select the \`.mcpb\` file

          ### What's New in v2.0
          - Complete TypeScript rewrite from Python
          - Dual-response pattern: index (all matches) + details (within token budget)
          - SQLite FTS5 replaces vector embeddings (96% smaller bundle)
          - Merged create/update into single \`memory_store\` tool
          - Automatic 20-word summaries for all memories
          - Hybrid scoring: FTS rank + importance + recency + frequency

          ### Token Efficiency
          - Quick lookup: 300-500 tokens (index + 1-2 details)
          - Standard search: 1000-1500 tokens (index + 5-7 details)
          - Deep dive: 3000-5000 tokens (index + 20-25 details)

          ### Documentation
          - [README](README.md)
          - [Developer Guide](CLAUDE.md)
          - [Release Notes](RELEASE_NOTES.md)" \
            ${MCPB_FILE:+$MCPB_FILE}
